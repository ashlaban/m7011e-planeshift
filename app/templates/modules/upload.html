{% extends "base.html" %}

{% block css %}
<link rel="stylesheet" type="text/css" href="/static/css/modules/module-base.css" />
<link rel="stylesheet" type="text/css" href="/static/css/modules/module-upload.css" />
{% endblock css %}

{% block js %}
<script src="/static/js/planeshift-api.js"></script>
<script src="/static/js/planeshift-viewmodel.js"></script>

<script type="text/javascript" charset="utf-8">
	var planeshift_view_model = new PlaneshiftViewModel();
	planeshift_view_model.get_module('{{module_name}}');

	document.addEventListener('DOMContentLoaded', function () {
		// Form interaction
		var form      = document.getElementById('upload-form');
		var uploadbtn = document.getElementById('upload-btn');
		uploadbtn.addEventListener('click', function(ev) {
  			planeshift_view_model.upload_files_from_form(form);
		}, false);

		var addfilesbtn = document.getElementById('add-files-btn');
		addfilesbtn.addEventListener('click', function(ev) {
			document.getElementById('files').click()
		});

		var clearfilesbtn = document.getElementById('clear-files-btn');
		clearfilesbtn.addEventListener('click', function(ev) {
			planeshift_view_model.clear_files();
		});

		var form = document.getElementById('upload-form');
		form.addEventListener('submit', function(ev) {
			ev.preventDefault();
		});

		// Dragging and dropping
		var box = document.getElementById('box');
		var dropzone = document.getElementById('dropzone');
		box.addEventListener('dragover', function(ev) {
			ev.preventDefault()
			document.getElementById('dropzone-label').innerHTML = 'Drop them!';
			console.log('Enter dropzone');
		}, false);
		box.addEventListener('dragleave', function(ev) {
			ev.preventDefault()
			document.getElementById('dropzone-label').innerHTML = 'Drag files here';
			console.log('Exit dropzone');
		}, false);

		box.addEventListener('drop', function(ev) {
			ev.preventDefault()
			document.getElementById('dropzone-label').innerHTML = 'Drag files here';
			planeshift_view_model.add_files(event.dataTransfer.files);
		}, false);

		// Update file field
		var filefield = document.getElementById('files');
		filefield.addEventListener('change', function (ev) {
			planeshift_view_model.add_files(ev.target.files);
		});

		// http://stackoverflow.com/questions/6756583/prevent-browser-from-loading-a-drag-and-dropped-file
		function prevent_default(e) {e = e || event; e.preventDefault();}
		window.addEventListener("drop"    , prevent_default, false);
		window.addEventListener("dragover", prevent_default, false);

		// Final init
		ko.applyBindings(planeshift_view_model);
	});
</script>
{% endblock %}

{% block content %}
<section class="center-content top-padding-md">
	<div id="box" class="form-box rounded center-content">
		<h1>{{module_name}} - New Version</h1>
		<p>Upload your main.js module file and be good to go! You can also upload additional resources. See the module guide for more info.</p>
		<p>Upload a file named <em>icon</em> to use as a representation of your module. It should be fairly small 150x150 is suitable. Note the lack of file extension.</p>
		<p><em>Note: Modules that do not conform to the site guidelines are subject to deletion.</em></p>
		<!-- TODO: Link to module info page. -->
		<!-- TODO: Link to guidelines. -->
		<p id="info" class="error"></p>

		<form id="upload-form" class="form center-content" action="" method="post" enctype="multipart/form-data" name="module_upload">
			<input type="text" name="version" id="version" class="wide-form-field", placeholder="New version name">
			<input id="files" multiple="" name="files" type="file">

			<div id="dropzone" class="center-content">
				<span id="dropzone-label">Drag files here</span>
				<ul data-bind="foreach: file_list">
					<li>
						<span class="delete-item fa-stack" data-bind="click: function(){planeshift_view_model.remove_file(name)}">
							<span class="fa fa-trash-o fa-stack-1x"></span>
							<span class="fa fa-trash fa-stack-1x"></span>
						</span>
						<span data-bind="text:name"></span>
					</li>
				</ul>
			</div>

			<div class="btn-list">
				{{macros.button("fa-upload", "Upload"   , "upload-btn"     )}}
				{{macros.button("fa-plus"  , "Add files", "add-files-btn"  )}}
				{{macros.button("fa-eraser", "Clear"    , "clear-files-btn")}}
			</div>
		</form>
	</div>
</section>
{% endblock content %}
